# Архитектура проекта

## Структура проекта
- `main.py` - Главный файл проекта
- `workBitrix.py` - Функции для работы с Bitrix24 API
- `parser_site/parse_page.py` - Парсер HTML-страниц каталога
- `parser_site/page_1.html` - Локальный HTML для парсинга (пример страницы каталога)
- `test.py` - Файл для тестирования
- `индивидуальный_расчет.docx` - Документ Word с расчетом
- `индивидуальный_расчет.pdf` - PDF версия документа с расчетом
- `индивидуальный_расчет.html` - HTML версия карточки товара с расчетом
- `hello_world.pdf` - Тестовый PDF файл
 - `insert_html_to_pdf.py` - Вставка HTML-страницы в существующий PDF
- `update_presentation.py` - Скрипт для замены текста в презентации PowerPoint
- `fonts/` - Директория с шрифтами
- `.venv/` - Виртуальное окружение Python
- `.env` - Файл с переменными окружения

## Описание файлов
- `main.py` - Основной скрипт, содержит главную логику приложения
  - `create_calculation_doc()` - Функция для генерации документов DOCX с расчетом
  - `create_calculation_html()` - Функция для генерации HTML-карточек товаров с расчетом (использует шрифт Open Sans Medium и отступ от левого края 20 см)
  - `replace_date_placeholder()` - Функция для замены текста "{дата+3}" на "21.03.25" в PDF файлах
  - `main()` - Главная асинхронная функция, обрабатывает данные сделки и создает презентацию
  - включает проверку существования PDF файла перед загрузкой в Bitrix
- `workBitrix.py` - Содержит функции для взаимодействия с API Bitrix24
  - `get_all_info(deal_id)` - Получает информацию о сделке и товарах, включая изображения из поля property160 товара
  - `download_images(url, namefield, productId, fileId)` - Скачивает изображения из Bitrix24 по API
  - `create_product(product_name, product_price, product_quantity, file_name_path, isBase64)` - Создает товар в каталоге
- `parser_site/parse_page.py` - Скрипт парсинга карточек каталога из HTML
  - `parse_catalog_items(html_text, base_url, download_images)` — извлекает список карточек с полями: `name`, `price`, `link`, `image`, `image_base64`
  - `_download_image_to_base64(image_url, base_url)` — загружает изображение и конвертирует в base64 формат `{'fileData': [filename, encoded_data]}`
  - CLI-параметры: `input` (путь к HTML), `--out` (путь к JSON/CSV), `--format` (`json|csv`), `--base-url` (базовый URL для изображений), `--download-images` (загружать изображения в base64)
- `индивидуальный_расчет.html` - HTML-версия карточки товара с индивидуальным расчетом, содержит таблицу с информацией о камне, его характеристиках, объеме, весе и цене. Включает CSS стили для корректного отображения таблицы с фиксированными размерами колонок (25%, 50%, 25%) и предотвращения выхода контента за границы
- `индивидуальный_расчет.docx` - Документ Word с аналогичной информацией
- `индивидуальный_расчет.pdf` - PDF документ с аналогичной информацией
 - `insert_html_to_pdf.py` - Скрипт, конвертирующий HTML в PDF и вставляющий страницу в базовый PDF
   - `insert_html_page_to_pdf()` - основная функция:
     - создает временную копию HTML, заменяя `image/jpg` на `image/jpeg`
     - декодирует все `data:image/*;base64` и транскодирует их в PNG через `Pillow`, затем подменяет на `data:image/png;base64`
     - конвертирует подготовленный HTML в PDF (`wkhtmltopdf` с `enable-local-file-access`, `encoding=utf-8`)
     - вставляет полученную страницу в `base_pdf_path` после `insert_after_page`
 - `fastApiWork.py` - FastAPI-приложение для приёма вебхуков и событий
   - эндпойнт `/event` — обработчик входящих событий Bitrix24
   - вспомогательная функция `_parse_request_data(request)` — универсальный парсер тела запроса (JSON → form-urlencoded → raw body)
- `update_presentation.py` - Скрипт для замены текста и изображений в презентации PowerPoint
   - `replace_text_and_images_in_presentation()` - основная функция замены текста и изображений во всех слайдах презентации
   - `create_presentation()` - главная функция с настройками путей, текста и изображений для замены
   - заменяет все вхождения `{дата+3}` на `21.09.25` и `{image0}` на изображение с размерами 3,52x2,07 см
   - конвертирует PPTX в PDF через LibreOffice headless режим (заменяет unoconv)
   - включает проверку существования файлов и обработку ошибок конвертации

## Зависимости
- `fast_bitrix24` - Библиотека для работы с API Bitrix24
- `fpdf` - Библиотека для создания PDF-документов
- `python-docx` - Библиотека для работы с документами в формате docx
- `lxml` - Библиотека для работы с XML и HTML
- `Pillow` - Библиотека для работы с изображениями
- `python-dotenv` - Библиотека для загрузки переменных окружения из файла .env
- `tqdm` - Библиотека для создания прогресс-баров
- `loguru` - Библиотека для логирования
- `python-pptx` - Библиотека для работы с презентациями PowerPoint
- `LibreOffice` - Офисный пакет для конвертации PPTX в PDF (headless режим)
- `subprocess` - Встроенный модуль Python для выполнения системных команд 